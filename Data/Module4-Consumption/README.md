<a name="HOLTop"></a>
# Module 4 - Consuming Data Pipelines #

---

<a name="Overview"></a>
## Overview ##

Now that we have a sound data pipeline, it is time to consume our data. The data can be consumed in multiple ways. Visualizations and dashboards, reporting, bots, machine learning and other LOB apps are just a few ways that your end data can be consumed.

In this module, we will be consuming data via the AzureML Recommendations API and a Bot. We have already discussed consuming data via PowerBI in Module 1 & 2, so, we will not be covering PowerBI in this section.

The Recommendations API built with Microsoft Azure Machine Learning helps your customer discover items in your catalog. Customer activity in your digital store is used to recommend items and to improve conversion in your digital store.

The Microsot bot framework provides Conversation-as-a-Platform service. It combines natural language processing with AI to help you create conversation channels and better assist your customers.


This module includes building an Azure ML Recommendations model using the results generated by your data pipeline, using the results generated by the model to power recommendations on the e-commerce site. Additionally, we will also see how to connect a bot to a data warehouse and access the data using the Bot Framework.

<a name="Objectives"></a>
### Objectives ###
In this module, you'll see how to:

- Analyze the users’ comments using Text Analytics
- Recognize users' emotions by their faces in an image

<a name="Prerequisites"></a>
### Prerequisites ###

The following is required to complete this module:

- [Visual Studio Community 2015][1] or greater.
- [NodeJS][2]

[1]: https://www.visualstudio.com/products/visual-studio-community-vs
[2]: https://nodejs.org/en/download/

<a name="Setup"></a>
### Setup ###



<a name="Exercise1"></a>
### Exercise 1: Adding Recommendations to your app ###

Microsoft Azure Machine Learning's Recommendations supports 3 common scenarios:
- **Frequently Bought Together (FBT) Recommendations**
	In this scenario the recommendations engine will recommend items that are likely to be purchased together in the same transaction with a particular item.

- **Item to Item Recommendations**
	A common scenario that uses this capability, is "people who visited/clicked this item, also visited/clicked this other item".

- **Customer to Item Recommendations**
	Given a customer's prior activity, it is possible to recommend items that the customer may be interested in.
	For instance, given all movies watched by a customer, it is possible to recommend additional content that may be of interest to the customer.

In this exercise, you'll set up and integrate the [Recommendations API](http://gallery.cortanaanalytics.com/MachineLearningAPI/Recommendations-2) in your website.
You will start building a Recommendations model and then, use the results generated by the model to power recommendations on the e-commerce site.

<a name="Ex1Task1"></a>
#### Task 1 - Signing up for the Recommendations API ####

In this task, you'll sign up for the Recommendations API service, and create a recommendations model.

1. You should sign up for the **Recommendations API** service. Go to the **Cortana Analytics Gallery** at http://gallery.cortanaanalytics.com/ and go to the **Machine Learning APIs** section.

1. Select the **Recommendations API**. Notice the Documentation and Sample links.

1. Click **Sign Up**. This link will take you to the Data Market, where you can sign up for the service.

1. Select a plan. You may select the **free tier for 10,000 transactions/month**. This is a free plan, so it won't require any other information (credit card, etc.) You will need a Microsoft Account to sign up for the service. If you don’t have one, you can create a Microsoft Account at no additional cost.

1. After you sign up for Recommendations, you'll be given an **API Key**. You can always see this key at https://datamarket.azure.com/account. Copy this key, as you'll need it when creating your first model.

	![Azure Marketplace](Images/ex1-task1-datamarket-key.png?raw=true "Azure Marketplace")

	_Azure Marketplace_

<a name="Ex1Task2"></a>
#### Task 2 - Creating a recommendations model ####

Now you, as a developer can take advantage of this API and do not have to worry about the details of how to actually build a model. You can take advantage of one that is already created.

In order to build a model, the engine will need two pieces of information, a catalog file, and a usage file. Usually you would query your transactions database for this information. 
#######START HERE#############

You simply create a "Recommendations Model" via the API.  The model requires a few things:
- You need your password and API key in order to authenticate to the API
- You create a "project" or model in the API
- You upload 2 sets of data to that project:
	- Your product catalog
	- Your usage information - what customers have done
- The last step is to train the model.

In this task, you have two alternatives to create the recommendations model. You can either use the sample app we provide, or you can use the Recommendations web UI.

##### Using the Recommendations UI #####

You can set up your model using the [Recommendations UI (Beta)](http://recommendations.azurewebsites.net/) and following three simple steps:

1. In the [Recommendations UI](http://recommendations.azurewebsites.net/) site, provide a name for the model and then click **Add Project**.

1. Add a Catalog file: use the **catalog_small.txt** one within the **Resources** folder located at **Source / Ex1 / Begin / RecommendationsSample**.

1. Add a Usage file: use the **usage_data.txt** one within the **Resources** folder located at **Source / Ex1 / Begin / RecommendationsSample**.

1. Create a build: we created a **Recommendation** build type.

	![Recommendations UI](Images/ex1-task1-recommendations-ui.png?raw=true "Recommendations UI")

	_Recommendations UI_

##### Alternative: Using the sample app #####

1. Open in Visual Studio the **RecommendationsSample.sln** solution located at **Source / Ex1 / Begin / RecommendationsSample** folder.

1. Open the **SampleApp.cs** file. The following tasks are going to be executed:
	- Create a Model
	- Add a catalog file
	- Add a usage file
	- Trigger a build for the Model
	- Get a recommendation based on a pair of items

1. Replace the values for the **accountEmail** and **accountKey** fields with your email and the key from the previous task.

1. Run the solution and take note of the **Model Id** that is shown when the application finishes, you'll need it for the following task.


<a name="Ex1Task3"></a>
#### Task 3 - Updating your website to get recommendations ####

In this task, you'll update the PartsUnlimited website to use the Recommendations API. To learn more, go to: https://azure.microsoft.com/en-us/documentation/articles/machine-learning-recommendation-api-documentation/

1. Open in Visual Studio the **PartsUnlimited.sln** solution located at **Source / Ex1 / Begin / PartsUnlimited** folder.

1. Open the **config.json** file located in the **PartsUnlimited** website.

1. Set the AzureMLRecommendations **AccountEmail**, **AccountKey** and **ModelId** settings with the values that you got from the previous task.

1. Now set the Azure DocumentDB **Endpoint** and **AuthKey** using the _URI_ and _Primary Key_ that you obtained while creating it in the [Creating the DocumentDB database](../Module1-IntelligentApp#task-1---creating-the-documentdb-database) module. If you do not have them, you can use these credentials:

 URL:
 https://data-module3.documents.azure.com:443/

 Key:
 mywgRcMYpcsaRo72hbTw4HZRnEPAMzffzEYZVCZXXOWlslpnsUDwACsftxQBdSIGCC0APiq3g9dYYk2J550Eqg==

1. Open the **AzureMLRecommendationEngine.cs** file located in the **Recommendations** folder.

1. Check the **GetRecommendationsAsync** method. Get recommendations of the active build of type "Recommendation" or "Fbt" based on a list of seeds (input) items. The response includes one entry per recommended item, including the Rating of the recommendation; higher number means higher confidence. This is what the product recommendation HTTP request looks like:

	````
	HTTP GET method
	<rootURI>/ItemRecommend?modelId=%27<modelId>%27&itemIds=%27<itemId>%27&numberOfResults=<int>&includeMetadata=<bool>&apiVersion=%271.0%27
	````

1. Run the application and select any product to see the details and recommended items.

	>**Note**: If you see any CSS issue, stop the app, right-click on PartsUnlimited Dependencies and select **Restore Packages**. Then, run the grunt task **default** in the 'Task Runner Explorer' window.

	![Recommendations for an item](Images/ex1-task2-website.png?raw=true "Recommendations for an item")

	_Recommendations for an item_






