<a name="HOLTop"></a>
# Module 4 - Consuming Data Pipelines #

---

<a name="Overview"></a>
## Overview ##

Now that we have a sound data pipeline, it is time to consume our data. The data can be consumed in multiple ways. Visualizations and dashboards, reporting, bots, machine learning and other LOB apps are just a few ways that your end data can be consumed.

In this module, we will be consuming data via the AzureML Recommendations API and a Bot. We have already discussed consuming data via PowerBI in Module 1 & 2, so, we will not be covering PowerBI in this section.

The Recommendations API built with Microsoft Azure Machine Learning helps your customer discover items in your catalog. Customer activity in your digital store is used to recommend items and to improve conversion in your digital store.

The Microsot bot framework provides Conversation-as-a-Platform service. It combines natural language processing with AI to help you create conversation channels and better assist your customers.


This module includes building an Azure ML Recommendations model using the results generated by your data pipeline, using the results generated by the model to power recommendations on the e-commerce site. Additionally, we will also see how to connect a bot to a data warehouse and access the data using the Bot Framework.

<a name="Objectives"></a>
### Objectives ###
In this module, you'll see how to:

- Analyze the usersâ€™ comments using Text Analytics
- Recognize users' emotions by their faces in an image

<a name="Prerequisites"></a>
### Prerequisites ###

The following is required to complete this module:

- [Visual Studio Community 2015][1] or greater.
- [NodeJS][2]

[1]: https://www.visualstudio.com/products/visual-studio-community-vs
[2]: https://nodejs.org/en/download/

<a name="Setup"></a>
### Setup ###



<a name="Exercise1"></a>
### Exercise 1: Adding Recommendations to your app ###

Microsoft Azure Machine Learning's Recommendations supports 3 common scenarios:
- **Frequently Bought Together (FBT) Recommendations**
	In this scenario the recommendations engine will recommend items that are likely to be purchased together in the same transaction with a particular item.

- **Item to Item Recommendations**
	A common scenario that uses this capability, is "people who visited/clicked this item, also visited/clicked this other item".

- **Customer to Item Recommendations**
	Given a customer's prior activity, it is possible to recommend items that the customer may be interested in.
	For instance, given all movies watched by a customer, it is possible to recommend additional content that may be of interest to the customer.

In this exercise, you'll set up and integrate the Product Recommendations API in your website.
You will start building a Recommendations model and then, use the results generated by the model to power recommendations on the e-commerce site.

<a name="Ex1Task1"></a>
#### Task 1 - Signing up for the Recommendations API ####

In this task, you'll sign up for the Recommendations API service, and create a recommendations model.

1. Navigate to the [Azure Portal](https://portal.azure.com) and click on **+New**.

1. Click on **Intelligence + Analytics** and click on **Cognitive Services APIs (preview)**. 

	TODO: Screenshot (setup-create-cs.png)


1. In the creation blad, provide an Account Name. In the **API Type** section, select the **Recommendations API (preview)**.

1. Choose the **Free** pricing tier, create or select appropriate resource group and click **Create**.

	TODO: Screenshot (setup-create-blade)	

1. Once created, in the **Overview** section of the Recommendations API, copy the **Endpoint** and keep it handy for the next section.

1. Next, click on the **Keys** section and copy one of the two keys. Keep it handy for the next section.	

<a name="Ex1Task2"></a>
#### Task 2 - Creating a recommendations model ####

Now you, as a developer can take advantage of this API and do not have to worry about the details of how to actually build a model. You can take advantage of one that is already created.

In order to build a model, the engine will need two pieces of information, a catalog file, and a usage file. 
If you've completed Module 2 of this lab, you should have the product catalog and the transaction file handy. You can also find these resource under the '..Module4-CognitiveIntelligence\data\' folder.

>**Note:** _How much data do you need?_ 
	<br>Well, it really depends on the usage data itself. The system learns when users buy different items. For some builds like FBT, it is important to know which items are purchased in the same transactions. (We call this co-occurrences). A good rule of thumb is to have most items be in 20 transactions or more, so if you had 10,000 items in your catalog, we would recommend that you have at least 20 times that number of transactions or about 200,000 transactions. Once again, this is a rule of thumb. You will need to experiment with your data. 


1. Open in Visual Studio the **RecommendationsSample.sln** solution located at **Module4-CognitiveServices/SampleApp/RecommendationsSample.sln** folder.

1. There are 4 main files that we're going to review
	- SampleApp.cs - The main file that included the application code. 
	- RecommendationsApiWrapper.cs - A wrapper that makes it easy to consume the recommendations API from C# 
	- Helpers.cs - Helper file with classes to simplify serialization/deserialization of the RESTful API requests/responses. 
	- BlobHelper.cs - Helper File to deal with Blob Storage. (Used only for batch scoring)
	
<br>
1. Open the **SampleApp.cs** file. The following tasks are going to be executed:
	- Create a Model
	- Add a catalog file
	- Add a usage file
	- Trigger a build for the Model
	- Get a recommendation based on a pair of items

1. Replace the values for the **AccountKey** and **BaseUri** fields with your key and Endpoint from the previous task.

1. You will need Product Catalog data and the Usage data. You can find that in the '..\Module4-Consumption\data' folder.

1. As mentioned earlier, in order to train the ML Recommendations model, we need to upload our Product Catalog and our website's usage data. This data was produced by output in Module 2. We will be consuming this output in order to train out model.

1. The Recommendations model expects the data to be in a certain format. All files need to be comma (,) separated.
	1. The following is the format the **Product Catalog** data needs to be in:
		- Product ID
		- Product Title
		- Category ID
		- Description (Optional)
		- Comma separated list of features (Optional)
	
	1. The following in the format the **Usage Data** needs to be in:
		- User ID
		- Product ID
		- Time (Format: yyyy/MM/ddThh:mm:ss)
		- Event (Purchase/Click/AddShopCart/RemovateShopCart)

1. Let's open the data files and see what the data looks like.

	- Product Catalog Data
		TODO: Screenshot

	- Usage Data
		TODO: Screenshot


1. Let's switch back to our visual studio solution and add the values for **ProductCatalogPath** and the **UsageFilesPath** variables with the folder paths of the product catalog and the usage data folders, respectively.

1. Run the solution and take note of the **Model Id** that is shown when the application finishes, you'll need it for the following task.

	TODO: Screenshot (ex1-console-output.png)

<a name="Ex1Task3"></a>
#### Task 3 - Viewing recommendations in action ####
	TODO: Task 3 is not working. Needs to be re-done

In this task, you'll update the PartsUnlimited website to use the Recommendations API. To learn more, go to: https://azure.microsoft.com/en-us/documentation/articles/machine-learning-recommendation-api-documentation/

1. Open in Visual Studio the **PartsUnlimited.sln** solution located at **Source / Ex1 / Begin / PartsUnlimited** folder.

1. Open the **config.json** file located in the **PartsUnlimited** website.

1. Set the AzureMLRecommendations **AccountEmail**, **AccountKey** and **ModelId** settings with the values that you got from the previous task.

1. Now set the Azure DocumentDB **Endpoint** and **AuthKey** using the _URI_ and _Primary Key_ that you obtained while creating it in the [Creating the DocumentDB database](../Module1-IntelligentApp#task-1---creating-the-documentdb-database) module. If you do not have them, you can use these credentials:

 URL:
 https://data-module3.documents.azure.com:443/

 Key:
 mywgRcMYpcsaRo72hbTw4HZRnEPAMzffzEYZVCZXXOWlslpnsUDwACsftxQBdSIGCC0APiq3g9dYYk2J550Eqg==

1. Open the **AzureMLRecommendationEngine.cs** file located in the **Recommendations** folder.

1. Check the **GetRecommendationsAsync** method. Get recommendations of the active build of type "Recommendation" or "Fbt" based on a list of seeds (input) items. The response includes one entry per recommended item, including the Rating of the recommendation; higher number means higher confidence. This is what the product recommendation HTTP request looks like:

	````
	HTTP GET method
	<rootURI>/ItemRecommend?modelId=%27<modelId>%27&itemIds=%27<itemId>%27&numberOfResults=<int>&includeMetadata=<bool>&apiVersion=%271.0%27
	````

1. Run the application and select any product to see the details and recommended items.

	>**Note**: If you see any CSS issue, stop the app, right-click on PartsUnlimited Dependencies and select **Restore Packages**. Then, run the grunt task **default** in the 'Task Runner Explorer' window.

	![Recommendations for an item](Images/ex1-task2-website.png?raw=true "Recommendations for an item")

	_Recommendations for an item_



### Appendix ###

1. [Recommendations API - Developer Reference](https://westus.dev.cognitive.microsoft.com/docs/services/Recommendations.V4.0/operations/56f30d77eda5650db055a3db)

1. [Recommendation API - Documentation](https://azure.microsoft.com/en-us/documentation/articles/machine-learning-recommendation-api-documentation/)


